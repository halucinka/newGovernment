'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _Map = require('babel-runtime/core-js/map')['default'];

var _Set = require('babel-runtime/core-js/set')['default'];

var _interopRequireWildcard = require('babel-runtime/helpers/interop-require-wildcard')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.recursivePatternCapture = recursivePatternCapture;

var _fs = require('fs');

var fs = _interopRequireWildcard(_fs);

var _crypto = require('crypto');

var _parse2 = require('./parse');

var _parse3 = _interopRequireDefault(_parse2);

var _resolve = require('./resolve');

var _resolve2 = _interopRequireDefault(_resolve);

var _ignore = require('./ignore');

var _ignore2 = _interopRequireDefault(_ignore);

// map from settings sha1 => path => export map objects
var exportCaches = new _Map();

var ExportMap = (function () {
  function ExportMap(context) {
    _classCallCheck(this, ExportMap);

    this.context = context;
    this.named = new _Set();

    this.errors = [];
  }

  /**
   * Traverse a patter/identifier node, calling 'callback'
   * for each leaf identifier.
   * @param  {node}   pattern
   * @param  {Function} callback
   * @return {void}
   */

  _createClass(ExportMap, [{
    key: 'resolveReExport',
    value: function resolveReExport(node, base) {
      var remotePath = _resolve2['default'].relative(node.source.value, base, this.settings);
      if (remotePath == null) return null;

      return ExportMap['for'](remotePath, this.context);
    }
  }, {
    key: 'captureDefault',
    value: function captureDefault(n) {
      if (n.type !== 'ExportDefaultDeclaration') return;
      this.named.add('default');
    }

    /**
     * capture all named exports from remote module.
     *
     * returns null if this node wasn't an ExportAllDeclaration
     * returns false if it was not resolved
     * returns true if it was resolved + parsed
     *
     * @param  {node} n
     * @param  {string} path - the path of the module currently parsing
     * @return {boolean?}
     */
  }, {
    key: 'captureAll',
    value: function captureAll(n, path) {
      if (n.type !== 'ExportAllDeclaration') return null;

      var remoteMap = this.resolveReExport(n, path);
      if (remoteMap == null) return false;

      remoteMap.named.forEach((function (name) {
        this.named.add(name);
      }).bind(this));

      return true;
    }
  }, {
    key: 'captureNamedDeclaration',
    value: function captureNamedDeclaration(n, path) {
      var _this = this;

      if (n.type !== 'ExportNamedDeclaration') return;

      // capture declaration
      if (n.declaration != null) {
        switch (n.declaration.type) {
          case 'FunctionDeclaration':
          case 'ClassDeclaration':
          case 'TypeAlias':
            // flowtype with babel-eslint parser
            this.named.add(n.declaration.id.name);
            break;
          case 'VariableDeclaration':
            n.declaration.declarations.forEach(function (d) {
              return recursivePatternCapture(d.id, function (id) {
                return _this.named.add(id.name);
              });
            });
            break;
        }
      }

      // capture specifiers
      var remoteMap = undefined;
      if (n.source) remoteMap = this.resolveReExport(n, path);

      n.specifiers.forEach((function (s) {
        if (s.type === 'ExportDefaultSpecifier') {
          // don't add it if it is not present in the exported module
          if (!remoteMap || !remoteMap.hasDefault) return;
        }

        this.named.add(s.exported.name);
      }).bind(this));
    }
  }, {
    key: 'settings',
    get: function get() {
      return this.context && this.context.settings;
    }
  }, {
    key: 'hasDefault',
    get: function get() {
      return this.named.has('default');
    }
  }, {
    key: 'hasNamed',
    get: function get() {
      return this.named.size > (this.hasDefault ? 1 : 0);
    }
  }], [{
    key: 'get',
    value: function get(source, context) {

      var path = (0, _resolve2['default'])(source, context);
      if (path == null) return null;

      return ExportMap['for'](path, context);
    }
  }, {
    key: 'for',
    value: function _for(path, context) {
      var exportMap = undefined;

      var cacheKey = hashObject(context.settings);
      var exportCache = exportCaches.get(cacheKey);
      if (exportCache === undefined) {
        exportCache = new _Map();
        exportCaches.set(cacheKey, exportCache);
      }

      exportMap = exportCache.get(path);
      // return cached ignore
      if (exportMap === null) return null;

      var stats = fs.statSync(path);
      if (exportMap != null) {
        // date equality check
        if (exportMap.mtime - stats.mtime === 0) {
          return exportMap;
        }
        // future: check content equality?
      }

      exportMap = ExportMap.parse(path, context);
      exportMap.mtime = stats.mtime;

      // ignore empties, optionally
      if (exportMap.named.size === 0 && (0, _ignore2['default'])(path, context)) {
        exportMap = null;
      }

      exportCache.set(path, exportMap);

      return exportMap;
    }
  }, {
    key: 'parse',
    value: function parse(path, context) {
      var m = new ExportMap(context);

      try {
        var ast = (0, _parse3['default'])(path, context);
      } catch (err) {
        m.errors.push(err);
        return m; // can't continue
      }

      ast.body.forEach(function (n) {
        m.captureDefault(n);
        m.captureAll(n, path);
        m.captureNamedDeclaration(n, path);
      });

      return m;
    }
  }]);

  return ExportMap;
})();

exports['default'] = ExportMap;

function recursivePatternCapture(pattern, callback) {
  switch (pattern.type) {
    case 'Identifier':
      // base case
      callback(pattern);
      break;

    case 'ObjectPattern':
      pattern.properties.forEach(function (_ref) {
        var value = _ref.value;

        recursivePatternCapture(value, callback);
      });
      break;

    case 'ArrayPattern':
      pattern.elements.forEach(function (element) {
        if (element == null) return;
        recursivePatternCapture(element, callback);
      });
      break;
  }
}

function hashObject(object) {
  var settingsShasum = (0, _crypto.createHash)('sha1');
  settingsShasum.update(JSON.stringify(object));
  return settingsShasum.digest('hex');
}
//# sourceMappingURL=data:application/json;base64,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QUMsQ0FBQTtBQUN6QyxnQkFBYyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUE7QUFDN0MsU0FBTyxjQUFjLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFBO0NBQ3BDIiwiZmlsZSI6ImNvcmUvZ2V0RXhwb3J0cy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJ1xuXG5pbXBvcnQgeyBjcmVhdGVIYXNoIH0gZnJvbSAnY3J5cHRvJ1xuXG5pbXBvcnQgcGFyc2UgZnJvbSAnLi9wYXJzZSdcbmltcG9ydCByZXNvbHZlIGZyb20gJy4vcmVzb2x2ZSdcbmltcG9ydCBpc0lnbm9yZWQgZnJvbSAnLi9pZ25vcmUnXG5cbi8vIG1hcCBmcm9tIHNldHRpbmdzIHNoYTEgPT4gcGF0aCA9PiBleHBvcnQgbWFwIG9iamVjdHNcbmNvbnN0IGV4cG9ydENhY2hlcyA9IG5ldyBNYXAoKVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBFeHBvcnRNYXAge1xuICBjb25zdHJ1Y3Rvcihjb250ZXh0KSB7XG4gICAgdGhpcy5jb250ZXh0ID0gY29udGV4dFxuICAgIHRoaXMubmFtZWQgPSBuZXcgU2V0KClcblxuICAgIHRoaXMuZXJyb3JzID0gW11cbiAgfVxuXG4gIGdldCBzZXR0aW5ncygpIHsgcmV0dXJuIHRoaXMuY29udGV4dCAmJiB0aGlzLmNvbnRleHQuc2V0dGluZ3MgfVxuXG4gIGdldCBoYXNEZWZhdWx0KCkgeyByZXR1cm4gdGhpcy5uYW1lZC5oYXMoJ2RlZmF1bHQnKSB9XG4gIGdldCBoYXNOYW1lZCgpIHsgcmV0dXJuIHRoaXMubmFtZWQuc2l6ZSA+ICh0aGlzLmhhc0RlZmF1bHQgPyAxIDogMCkgfVxuXG4gIHN0YXRpYyBnZXQoc291cmNlLCBjb250ZXh0KSB7XG5cbiAgICB2YXIgcGF0aCA9IHJlc29sdmUoc291cmNlLCBjb250ZXh0KVxuICAgIGlmIChwYXRoID09IG51bGwpIHJldHVybiBudWxsXG5cbiAgICByZXR1cm4gRXhwb3J0TWFwLmZvcihwYXRoLCBjb250ZXh0KVxuICB9XG5cbiAgc3RhdGljIGZvcihwYXRoLCBjb250ZXh0KSB7XG4gICAgbGV0IGV4cG9ydE1hcFxuXG4gICAgY29uc3QgY2FjaGVLZXkgPSBoYXNoT2JqZWN0KGNvbnRleHQuc2V0dGluZ3MpXG4gICAgbGV0IGV4cG9ydENhY2hlID0gZXhwb3J0Q2FjaGVzLmdldChjYWNoZUtleSlcbiAgICBpZiAoZXhwb3J0Q2FjaGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgZXhwb3J0Q2FjaGUgPSBuZXcgTWFwKClcbiAgICAgIGV4cG9ydENhY2hlcy5zZXQoY2FjaGVLZXksIGV4cG9ydENhY2hlKVxuICAgIH1cblxuICAgIGV4cG9ydE1hcCA9IGV4cG9ydENhY2hlLmdldChwYXRoKVxuICAgIC8vIHJldHVybiBjYWNoZWQgaWdub3JlXG4gICAgaWYgKGV4cG9ydE1hcCA9PT0gbnVsbCkgcmV0dXJuIG51bGxcblxuICAgIGNvbnN0IHN0YXRzID0gZnMuc3RhdFN5bmMocGF0aClcbiAgICBpZiAoZXhwb3J0TWFwICE9IG51bGwpIHtcbiAgICAgIC8vIGRhdGUgZXF1YWxpdHkgY2hlY2tcbiAgICAgIGlmIChleHBvcnRNYXAubXRpbWUgLSBzdGF0cy5tdGltZSA9PT0gMCkge1xuICAgICAgICByZXR1cm4gZXhwb3J0TWFwXG4gICAgICB9XG4gICAgICAvLyBmdXR1cmU6IGNoZWNrIGNvbnRlbnQgZXF1YWxpdHk/XG4gICAgfVxuXG4gICAgZXhwb3J0TWFwID0gRXhwb3J0TWFwLnBhcnNlKHBhdGgsIGNvbnRleHQpXG4gICAgZXhwb3J0TWFwLm10aW1lID0gc3RhdHMubXRpbWVcblxuICAgIC8vIGlnbm9yZSBlbXB0aWVzLCBvcHRpb25hbGx5XG4gICAgaWYgKGV4cG9ydE1hcC5uYW1lZC5zaXplID09PSAwICYmIGlzSWdub3JlZChwYXRoLCBjb250ZXh0KSkge1xuICAgICAgZXhwb3J0TWFwID0gbnVsbFxuICAgIH1cblxuICAgIGV4cG9ydENhY2hlLnNldChwYXRoLCBleHBvcnRNYXApXG5cbiAgICByZXR1cm4gZXhwb3J0TWFwXG4gIH1cblxuICBzdGF0aWMgcGFyc2UocGF0aCwgY29udGV4dCkge1xuICAgIHZhciBtID0gbmV3IEV4cG9ydE1hcChjb250ZXh0KVxuXG4gICAgdHJ5IHtcbiAgICAgIHZhciBhc3QgPSBwYXJzZShwYXRoLCBjb250ZXh0KVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbS5lcnJvcnMucHVzaChlcnIpXG4gICAgICByZXR1cm4gbSAvLyBjYW4ndCBjb250aW51ZVxuICAgIH1cblxuICAgIGFzdC5ib2R5LmZvckVhY2goZnVuY3Rpb24gKG4pIHtcbiAgICAgIG0uY2FwdHVyZURlZmF1bHQobilcbiAgICAgIG0uY2FwdHVyZUFsbChuLCBwYXRoKVxuICAgICAgbS5jYXB0dXJlTmFtZWREZWNsYXJhdGlvbihuLCBwYXRoKVxuICAgIH0pXG5cbiAgICByZXR1cm4gbVxuICB9XG5cbiAgcmVzb2x2ZVJlRXhwb3J0KG5vZGUsIGJhc2UpIHtcbiAgICB2YXIgcmVtb3RlUGF0aCA9IHJlc29sdmUucmVsYXRpdmUobm9kZS5zb3VyY2UudmFsdWUsIGJhc2UsIHRoaXMuc2V0dGluZ3MpXG4gICAgaWYgKHJlbW90ZVBhdGggPT0gbnVsbCkgcmV0dXJuIG51bGxcblxuICAgIHJldHVybiBFeHBvcnRNYXAuZm9yKHJlbW90ZVBhdGgsIHRoaXMuY29udGV4dClcbiAgfVxuXG4gIGNhcHR1cmVEZWZhdWx0KG4pIHtcbiAgICBpZiAobi50eXBlICE9PSAnRXhwb3J0RGVmYXVsdERlY2xhcmF0aW9uJykgcmV0dXJuXG4gICAgdGhpcy5uYW1lZC5hZGQoJ2RlZmF1bHQnKVxuICB9XG5cbiAgLyoqXG4gICAqIGNhcHR1cmUgYWxsIG5hbWVkIGV4cG9ydHMgZnJvbSByZW1vdGUgbW9kdWxlLlxuICAgKlxuICAgKiByZXR1cm5zIG51bGwgaWYgdGhpcyBub2RlIHdhc24ndCBhbiBFeHBvcnRBbGxEZWNsYXJhdGlvblxuICAgKiByZXR1cm5zIGZhbHNlIGlmIGl0IHdhcyBub3QgcmVzb2x2ZWRcbiAgICogcmV0dXJucyB0cnVlIGlmIGl0IHdhcyByZXNvbHZlZCArIHBhcnNlZFxuICAgKlxuICAgKiBAcGFyYW0gIHtub2RlfSBuXG4gICAqIEBwYXJhbSAge3N0cmluZ30gcGF0aCAtIHRoZSBwYXRoIG9mIHRoZSBtb2R1bGUgY3VycmVudGx5IHBhcnNpbmdcbiAgICogQHJldHVybiB7Ym9vbGVhbj99XG4gICAqL1xuICBjYXB0dXJlQWxsKG4sIHBhdGgpIHtcbiAgICBpZiAobi50eXBlICE9PSAnRXhwb3J0QWxsRGVjbGFyYXRpb24nKSByZXR1cm4gbnVsbFxuXG4gICAgdmFyIHJlbW90ZU1hcCA9IHRoaXMucmVzb2x2ZVJlRXhwb3J0KG4sIHBhdGgpXG4gICAgaWYgKHJlbW90ZU1hcCA9PSBudWxsKSByZXR1cm4gZmFsc2VcblxuICAgIHJlbW90ZU1hcC5uYW1lZC5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7IHRoaXMubmFtZWQuYWRkKG5hbWUpIH0uYmluZCh0aGlzKSlcblxuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICBjYXB0dXJlTmFtZWREZWNsYXJhdGlvbihuLCBwYXRoKSB7XG4gICAgaWYgKG4udHlwZSAhPT0gJ0V4cG9ydE5hbWVkRGVjbGFyYXRpb24nKSByZXR1cm5cblxuICAgIC8vIGNhcHR1cmUgZGVjbGFyYXRpb25cbiAgICBpZiAobi5kZWNsYXJhdGlvbiAhPSBudWxsKSB7XG4gICAgICBzd2l0Y2ggKG4uZGVjbGFyYXRpb24udHlwZSkge1xuICAgICAgICBjYXNlICdGdW5jdGlvbkRlY2xhcmF0aW9uJzpcbiAgICAgICAgY2FzZSAnQ2xhc3NEZWNsYXJhdGlvbic6XG4gICAgICAgIGNhc2UgJ1R5cGVBbGlhcyc6IC8vIGZsb3d0eXBlIHdpdGggYmFiZWwtZXNsaW50IHBhcnNlclxuICAgICAgICAgIHRoaXMubmFtZWQuYWRkKG4uZGVjbGFyYXRpb24uaWQubmFtZSlcbiAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlICdWYXJpYWJsZURlY2xhcmF0aW9uJzpcbiAgICAgICAgICBuLmRlY2xhcmF0aW9uLmRlY2xhcmF0aW9ucy5mb3JFYWNoKChkKSA9PlxuICAgICAgICAgICAgcmVjdXJzaXZlUGF0dGVybkNhcHR1cmUoZC5pZCwgaWQgPT4gdGhpcy5uYW1lZC5hZGQoaWQubmFtZSkpKVxuICAgICAgICAgIGJyZWFrXG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gY2FwdHVyZSBzcGVjaWZpZXJzXG4gICAgbGV0IHJlbW90ZU1hcFxuICAgIGlmIChuLnNvdXJjZSkgcmVtb3RlTWFwID0gdGhpcy5yZXNvbHZlUmVFeHBvcnQobiwgcGF0aClcblxuICAgIG4uc3BlY2lmaWVycy5mb3JFYWNoKGZ1bmN0aW9uIChzKSB7XG4gICAgICBpZiAocy50eXBlID09PSAnRXhwb3J0RGVmYXVsdFNwZWNpZmllcicpIHtcbiAgICAgICAgLy8gZG9uJ3QgYWRkIGl0IGlmIGl0IGlzIG5vdCBwcmVzZW50IGluIHRoZSBleHBvcnRlZCBtb2R1bGVcbiAgICAgICAgaWYgKCFyZW1vdGVNYXAgfHwgIXJlbW90ZU1hcC5oYXNEZWZhdWx0KSByZXR1cm5cbiAgICAgIH1cblxuICAgICAgdGhpcy5uYW1lZC5hZGQocy5leHBvcnRlZC5uYW1lKVxuICAgIH0uYmluZCh0aGlzKSlcbiAgfVxufVxuXG5cbi8qKlxuICogVHJhdmVyc2UgYSBwYXR0ZXIvaWRlbnRpZmllciBub2RlLCBjYWxsaW5nICdjYWxsYmFjaydcbiAqIGZvciBlYWNoIGxlYWYgaWRlbnRpZmllci5cbiAqIEBwYXJhbSAge25vZGV9ICAgcGF0dGVyblxuICogQHBhcmFtICB7RnVuY3Rpb259IGNhbGxiYWNrXG4gKiBAcmV0dXJuIHt2b2lkfVxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVjdXJzaXZlUGF0dGVybkNhcHR1cmUocGF0dGVybiwgY2FsbGJhY2spIHtcbiAgc3dpdGNoIChwYXR0ZXJuLnR5cGUpIHtcbiAgICBjYXNlICdJZGVudGlmaWVyJzogLy8gYmFzZSBjYXNlXG4gICAgICBjYWxsYmFjayhwYXR0ZXJuKVxuICAgICAgYnJlYWtcblxuICAgIGNhc2UgJ09iamVjdFBhdHRlcm4nOlxuICAgICAgcGF0dGVybi5wcm9wZXJ0aWVzLmZvckVhY2goKHsgdmFsdWUgfSkgPT4ge1xuICAgICAgICByZWN1cnNpdmVQYXR0ZXJuQ2FwdHVyZSh2YWx1ZSwgY2FsbGJhY2spXG4gICAgICB9KVxuICAgICAgYnJlYWtcblxuICAgIGNhc2UgJ0FycmF5UGF0dGVybic6XG4gICAgICBwYXR0ZXJuLmVsZW1lbnRzLmZvckVhY2goKGVsZW1lbnQpID0+IHtcbiAgICAgICAgaWYgKGVsZW1lbnQgPT0gbnVsbCkgcmV0dXJuXG4gICAgICAgIHJlY3Vyc2l2ZVBhdHRlcm5DYXB0dXJlKGVsZW1lbnQsIGNhbGxiYWNrKVxuICAgICAgfSlcbiAgICAgIGJyZWFrXG4gIH1cbn1cblxuZnVuY3Rpb24gaGFzaE9iamVjdChvYmplY3QpIHtcbiAgY29uc3Qgc2V0dGluZ3NTaGFzdW0gPSBjcmVhdGVIYXNoKCdzaGExJylcbiAgc2V0dGluZ3NTaGFzdW0udXBkYXRlKEpTT04uc3RyaW5naWZ5KG9iamVjdCkpXG4gIHJldHVybiBzZXR0aW5nc1NoYXN1bS5kaWdlc3QoJ2hleCcpXG59XG4iXX0=